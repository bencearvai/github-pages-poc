name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    permissions:
      id-token: write
      contents: read
      pages: write
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    # Checkout repo
    - uses: actions/checkout@v4

    # Set up Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # Install dependencies
    - name: Install dependencies
      run: npm ci

    # Install Playwright browsers
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # Run tests â€” continue even if tests fail
    - name: Run Playwright tests
      run: npx playwright test --reporter=html
      continue-on-error: true

    # Setup Pages
    - name: Setup Pages
      if: always()
      uses: actions/configure-pages@v4

    # Pull existing gh-pages branch to preserve old reports
    - name: Download existing Pages content
      if: always()
      run: |
        git clone --depth 1 --branch gh-pages "https://github.com/${GITHUB_REPOSITORY}.git" pages || mkdir -p pages

    # Copy the new report into a timestamped folder
    - name: Copy new report
      if: always()
      run: |
        mkdir -p pages/reports
        DATE=$(date +'%Y-%m-%d_%H-%M-%S')
        SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
        REPORT_DIR="reports/${DATE}_${SHORT_SHA}"
        mkdir -p "pages/${REPORT_DIR}"
        cp -r playwright-report/* "pages/${REPORT_DIR}"
        echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

    # Update index.html with a new entry linking to the commit on GitHub
    - name: Update index.html
      if: always()
      run: |
        INDEX_FILE=pages/index.html
        REPO_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"

        # Create skeleton if index doesn't exist
        if [ ! -f "$INDEX_FILE" ]; then
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Playwright Reports</title></head><body><h1>Playwright Reports</h1><ul>" > $INDEX_FILE
          echo "</ul></body></html>" >> $INDEX_FILE
        fi

        # Build the new entry with clickable commit link
        NEW_ENTRY="<li><a href='${REPORT_DIR}/index.html'>Report from ${DATE} (commit <a href='${REPO_URL}'>${SHORT_SHA}</a>)</a></li>"

        # Insert new entry right after <ul> so it appears under the title
        awk -v entry="$NEW_ENTRY" '/<ul>/{print;print entry;next}1' $INDEX_FILE > temp && mv temp $INDEX_FILE

    # Upload all Pages content
    - name: Upload artifact to GitHub Pages
      if: always()
      uses: actions/upload-pages-artifact@v4
      with:
        path: pages

    # Deploy to GitHub Pages
    - name: Deploy to GitHub Pages
      if: always()
      uses: actions/deploy-pages@v4
